<style scoped>
    .table-edit-field {
        border: none;
        background: transparent;
    }

    .table {
        text-align: left;
        font-size: 14px;
        font-weight: 900;
    }

    input {
        font-size: 13px;
        font-weight: 700;
    }


</style>

<div id="vue-sheet-{{ sheet.id }}">
    <div class="table-container" id="table-container-{{ sheet.id }}">
        <div>
            <div>
                <h3>{{ period }}:{{ sheet.sheetbase.name }}<button type="button" class="fa fa-times table-button big-button" style="margin-left:20px;" @click="delete_sheet()"></button></h3>
            </div>

            <div v-if="!categories.length" align="center">
                <h3 style="display: inline-block">No categories for sheet "{{ sheet.sheetbase.name  }}"</h3>
                <a href="/settings" style="display: inline-block"><button class="fa fa-edit table-button big-button" style="margin-left: 10px"></button></a>
                <br>
                <b>Add them to work with table</b>
            </div>

            <table class="table table-striped table-sm" v-if="categories.length">

              <thead>

                <tr class="tr-total" v-if="rows.length">
                    <td></td>
                    <td></td>
                    <td>Earnings: [[ earnings ]]</td>
                    <td>Costs: [[ costs ]]</td>
                    <td></td>
                    <td :style="'color: ' + [ delta < 0 ? 'red' : 'green' ]">Total: [[ delta ]]</td>
                    <td></td>
                </tr>


                <tr class="tr-total">

                  <th v-for="column in columns" :width="column.width">
                    <button  @click="change_sortField(column.sortKey)" class="table-text-button">[[ column.label ]]</button>
                    <a v-show="sortField == column.sortKey" :class="'fa fa-arrow-' + [ sortReverse === -1 ? 'up' : 'down' ]" @click="change_sortField(column.sortKey)"/>
                  </th>
                </tr>

              </thead>
              <tbody>


                <tr v-for="(row,index) in sorted_rows" >
                   <td style="font-weight: 900; font-size: 18px" :style="'color: ' + [ row.fields.value > 0 ? 'green' : 'red' ] ">[[ row.fields.value > 0 ? '+': '-' ]]</td>
                   <td>
                      <button v-on:click="pin_row(index)" class="table-image-button sml-button">
                          <img :src="'/img/booker/' + [ row.fields.pinned ? 'pinned' : 'unpinned' ] + '.png'" class="sml-button"/>
                      </button>
                  </td>
                  <td>
                     <input class="table-edit-field" @focus="onFocus=true;" @blur="update_row(index); onFocus=false;" v-model="row.fields.name" type="text" required>
                  </td>
                  <td>
                      <input class="table-edit-field"  @focus="onFocus=true;" @blur="update_row(index); onFocus=false;" v-model="row.fields.descr" type="text" >
                  </td>
                  <td>
                    <select class='form-control-sm' v-model="row.fields.category" @change="update_row(index); chartUpdated = !chartUpdated; format_value(row);">
                        <option v-for="cat in categories" :value="cat.pk">[[ cat.fields.name ]]</option>
                    </select>
                  </td>
                  <td>
                    <input class="table-edit-field" @focus="onFocus=true;" @blur="format_value(row); update_row(index); onFocus=false;" @keyup="chartUpdated = !chartUpdated" v-model.number="row.fields.value" type="number" required>
                  </td>
                  <td style="width: 18%;">
                    <button class="fa fa-xs fa-times table-button sml-button" type="button" @click="delete_row(index);"></button>
                  </td>
                </tr>


                <tr>
                    <td></td>
                    <td></td>
                    <td>
                        <div>
                          <input class="form-control" placeholder="Name" v-model="input.fields.name" id="name" type="text" ref="name" required>
                        </div>
                    </td>
                  <td>
                      <div>
                          <input class="form-control" placeholder="Description" v-model="input.fields.descr" id="descr" type="text">
                      </div>
                  </td>
                  <td>
                        <div>
                            <select class="form-control" v-model="input.fields.category" @change="format_value(input);" style="width: calc(100% - 45px); display: inline-block;">
                                <option v-for="cat in categories" :value="cat.pk">[[ cat.fields.name ]]</option>
                            </select>
                        <a href="/settings" style="display: inline-block"><button class="fa fa-xs fa-edit table-button sml-button" style="margin-left: 5px"></button></a>
                        </div>
                  </td>
                  <td>
                    <div>
                      <input class="form-control" v-model.number="input.fields.value" type="number" required>
                    </div>
                  </td>

                  <td><button @click="format_value(input); add_row();" class="fa fa-xs fa-plus table-button sml-button"></button></td>
                </tr>

                <tr class="tr-total" v-if="rows.length > 10">
                    <td></td>
                    <td></td>
                    <td>Earnings: [[ earnings ]]</td>

                    <td>Costs: [[ costs ]]</td>
                    <td></td>
                    <td :style="'color: ' + [ delta < 0 ? 'red' : 'green' ]">Total: [[ delta ]]</td>
                    <td></td>
                </tr>


              </tbody>
            </table>
        </div>
    </div>


    <template v-if="chartData.length">
        <div class="chart-container" id="chart-container-{{ sheet.id }}"/>
    </template>

    <template v-else>
        <div align="right"  style="margin-right: 10%">
        <h3>No costs to display</h3>
        </div>
    </template>

</div>






<script >
    var activities = JSON.parse({{ activities|safe|tojson }});
    var sheet = {{ sheet.id }};
    var categories = JSON.parse({{ categories|safe|tojson }})

    Vue.component('total-row', {
      props: ['earnings', 'costs', 'delta'],
      template:
`<tr class="tr-total" v-if="rows.length > 10">
<td></td>
<td></td>
<td>Earnings: [[ earnings ]]</td>

<td>Costs: [[ costs ]]</td>
<td></td>
<td :style="'color: ' + [ delta < 0 ? 'red' : 'green' ]">Total: [[ delta ]]</td>
<td></td>
</tr>`
    });


    vueTable{{ sheet.id }} = new Vue({
        el: '#vue-sheet-{{ sheet.id }}',

        data: {
            columns: [
                {label:'', sortKey: NaN, width: '2%'},
                {label:'Pin', sortKey: 'pinned', width: '7%'},
                {label:'Name', sortKey: 'name', width: '28%'},
                {label:'Description', sortKey: 'descr', width: '20%'},
                {label:'Category', sortKey:'category', width: '25%'},
                {label:'Price', sortKey:'value', width: '8%'},
                {label:'Action', sortKey: NaN, width: '10%'}
            ],
            rows: activities,
            input: {
                fields: {
                    pinned: false,
                    sheet: this.sheet,
                    category: this.categories[0] ? this.categories[0].pk : 0,
                    value: 200
                }
            },
            categories: categories,
            sheet: sheet,
            isAlive: true,
            sortField: 'pinned',
            sortReverse: -1,
            chartUpdated: false,
            onFocus: false
        },

       methods: {
        add_row: function() {
            copy = JSON.parse(JSON.stringify(this.input));
            axios.post('/booker/add_activity', JSON.stringify(copy.fields)).then(response => (
                    copy.pk = response.data.pk
            ));
            this.rows.push(copy);
            this.$refs.name.focus();

        },

        delete_row: function(index) {
            axios.post('/booker/delete_activity', JSON.stringify({'id': this.rows[index].pk}));
            this.rows.splice(index, 1);
        },

        update_row: function(index) {
            let kwargs = this.rows[index].fields;
            kwargs.id = this.rows[index].pk;
            axios.post('/booker/update_activity', JSON.stringify(this.rows[index].fields));
        },

        pin_row: function (index) {
            this.rows[index].fields.pinned = !this.rows[index].fields.pinned;
            this.sortField ='pinned';
            this.update_row(index);

        },
        
        delete_sheet: function () {
            this.isAlive=false;
            axios.post('/booker/delete_sheet', JSON.stringify({sheet_id: this.sheet}));
        },
           
        table_sorter: function (r1, r2) {
            if (r1.fields[this.sortField]> r2.fields[this.sortField])
                return this.sortReverse;
            if (r1.fields[this.sortField] < r2.fields[this.sortField])
                return -this.sortReverse;
            return 0;
        },

        change_sortField: function(key){
            if (this.sortField === key)
                this.sortReverse = -this.sortReverse;
            else
                this.sortReverse = -1;

            this.sortField = key

        },

        format_value: function(row)  {
            this.categories.forEach(function(cat){
                if (!cat.fields.positive && cat.pk === row.fields.category) {
                    row.fields.value = -Math.abs(row.fields.value)
                } else if (cat.fields.positive && cat.pk === row.fields.category) {
                    row.fields.value = Math.abs(row.fields.value)
                }
            });
        }

       },

       computed: {
            costs: function() {
                var total = 0;
                this.rows.forEach(function (row) {
                    if(row.fields.value < 0) {
                        total += row.fields.value;
                    }
                });

                return total;
            },

            earnings: function() {
                var total = 0;
                this.rows.forEach(function (row) {

                    if(row.fields.value > 0) {
                        total += row.fields.value;
                    }
                });

                return total;
            },

            delta: function() {
                return this.costs + this.earnings;

            },

            sorted_rows: function () {
                if (!this.onFocus) {
                    this.rows.sort(this.table_sorter);
                    gt_zero = this.rows.filter(row => row.fields.value > 0)
                    lt_zero = this.rows.filter(row => row.fields.value <= 0)
                    this.rows = gt_zero.concat(lt_zero);

                }
                return this.rows
            },

            chartData: function() {
                sums = {};

                 this.categories.forEach(function(cat) {
                    sums[String(cat.pk)] = {y: 0, name: cat.fields.name, color: cat.fields.color}
                 });

                this.rows.forEach(function(row) {
                     if (row.fields.value < 0) {
                        sums[String(row.fields.category)].y += row.fields.value
                    }
                });

                res = [];

                for (const [key, value] of Object.entries(sums)) {
                    if (value.y !== 0) {
                        res.push(value)
                    }
                }

                return res
            }

       }

    });

    vueTable{{ sheet.id }}.$watch('isAlive', function () {
        $("#sheet-container-{{ sheet.id }}").remove();
    });

    vueTable{{ sheet.id }}.$watch('chartUpdated', function () {
        renderChart(vueTable{{ sheet.id }}.chartData, 'chart-container-{{ sheet.id }}')
    });

    vueTable{{ sheet.id }}.$watch('rows', function () {
        renderChart(vueTable{{ sheet.id }}.chartData, 'chart-container-{{ sheet.id }}')
    });
    renderChart(vueTable{{ sheet.id }}.chartData, 'chart-container-{{ sheet.id }}');


</script>

